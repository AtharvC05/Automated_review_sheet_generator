<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Review Summary</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common-styles.css') }}">
</head>
<body>
    <div class="page-header">
    <div class="header-left"></div>
    <div class="header-center">
        <h1>Final Review Summary</h1>
    </div>
    <div class="menu-container">
        <button class="menu-toggle" onclick="toggleMenu()">
            <span class="menu-line"></span>
            <span class="menu-line"></span>
            <span class="menu-line"></span>
        </button>
        
        <div class="menu-dropdown" id="menuDropdown">
            <!-- Database Management -->
            <a href="/data-manager" class="menu-item">
                <span class="icon">üóÑÔ∏è</span>
                Database Manager
            </a>
            <a href="/scheduler" class="menu-item current">
                <span class="icon">üìÖ</span>
                Review Scheduler
            </a>
            <div class="menu-divider"></div>
            
            <!-- Review Pages -->
            <a href="/review1" class="menu-item">
                <span class="icon">üìù</span>
                Review I - Scope
            </a>
            
            <a href="/review2" class="menu-item">
                <span class="icon">üîç</span>
                Review II - Design
            </a>
            
            <a href="/review3" class="menu-item">
                <span class="icon">‚öôÔ∏è</span>
                Review III - Implementation
            </a>
            
            <a href="/review4" class="menu-item">
                <span class="icon">üß™</span>
                Review IV - Testing
            </a>
            
            <a href="/review5" class="menu-item">
                <span class="icon">üìä</span>
                Review V - Final
            </a>
            
            <div class="menu-divider"></div>
            
            <!-- Additional Options -->
            <a href="/" class="menu-item">
                <span class="icon">üè†</span>
                Home
            </a>
        </div>
    </div>
<div class="content-wrapper">
    <!-- Your form goes here -->


    <form id="form-data">
        
        <label for="group_id">Group ID:</label>
        <input type="text" id="group_id" name="group_id" required readonly>
        
        <div class="table-responsive">
            <h3>Student Performance Summary</h3>
            <table id="summary-table">
                <thead>
                    <tr>
                        <th rowspan="2">Review Sheet</th>
                        <th colspan="4">Students (Total Marks)</th>
                    </tr>
                    <tr>
                        <th>Student 1</th>
                        <th>Student 2</th>
                        <th>Student 3</th>
                        <th>Student 4</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Review I</td>
                        <td><input type="number" id="review1-student1" name="review1_1" readonly></td>
                        <td><input type="number" id="review1-student2" name="review1_2" readonly></td>
                        <td><input type="number" id="review1-student3" name="review1_3" readonly></td>
                        <td><input type="number" id="review1-student4" name="review1_4" readonly></td>
                    </tr>
                    <tr>
                        <td>Review II</td>
                        <td><input type="number" id="review2-student1" name="review2_1" readonly></td>
                        <td><input type="number" id="review2-student2" name="review2_2" readonly></td>
                        <td><input type="number" id="review2-student3" name="review2_3" readonly></td>
                        <td><input type="number" id="review2-student4" name="review2_4" readonly></td>
                    </tr>
                    <tr>
                        <td>Review III</td>
                        <td><input type="number" id="review3-student1" name="review3_1" readonly></td>
                        <td><input type="number" id="review3-student2" name="review3_2" readonly></td>
                        <td><input type="number" id="review3-student3" name="review3_3" readonly></td>
                        <td><input type="number" id="review3-student4" name="review3_4" readonly></td>
                    </tr>
                    <tr>
                        <td>Review IV</td>
                        <td><input type="number" id="review4-student1" name="review4_1" readonly></td>
                        <td><input type="number" id="review4-student2" name="review4_2" readonly></td>
                        <td><input type="number" id="review4-student3" name="review4_3" readonly></td>
                        <td><input type="number" id="review4-student4" name="review4_4" readonly></td>
                    </tr>
                    <tr class="final-total">
                        <td>Final Total (100M)</td>
                        <td><input type="number" id="final-student1" name="final_1" readonly></td>
                        <td><input type="number" id="final-student2" name="final_2" readonly></td>
                        <td><input type="number" id="final-student3" name="final_3" readonly></td>
                        <td><input type="number" id="final-student4" name="final_4" readonly></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <label for="comments">Final Comments:</label>
            <textarea id="comments" name="c5" rows="4" placeholder="Enter any final comments here"></textarea>
        </div>

        <div class="button-group">
            <button type="button" id="back-review" onclick="previousReview()">Back</button>
            <button type="button" id="generate-pdf" onclick="submitForm()">Generate Final PDF</button>
        </div>
    </form>
</div>
    <script>
        // Load saved data from all review sheets
        document.addEventListener('DOMContentLoaded', function() {
            loadReviewData();
            calculateFinalTotals();
        });
    
        // Load data from all previous reviews
        function loadReviewData() {
            // Load group ID from any review
            const review1Data = JSON.parse(sessionStorage.getItem('review1_data') || '{}');
            const review2Data = JSON.parse(sessionStorage.getItem('review2_data') || '{}');
            const review3Data = JSON.parse(sessionStorage.getItem('review3_data') || '{}');
            const review4Data = JSON.parse(sessionStorage.getItem('review4_data') || '{}');
    
            // Debug: Log what's being loaded
            console.log("Review 1 Data:", review1Data);
            console.log("Review 2 Data:", review2Data);
            console.log("Review 3 Data:", review3Data);
            console.log("Review 4 Data:", review4Data);
    
            // Set group ID (take from any available review)
            const groupId = review1Data.group_id || review2Data.group_id || 
                           review3Data.group_id || review4Data.group_id || '';
            document.getElementById('group_id').value = groupId;
    
            // Load Review I totals
         // These are stored as 1.1.s1, 1.2.s1, etc. in review1.html
                document.getElementById('review1-student1').value = review1Data['1.1.s1'] || 0;
                document.getElementById('review1-student2').value = review1Data['1.2.s1'] || 0;
                document.getElementById('review1-student3').value = review1Data['1.3.s1'] || 0;
                document.getElementById('review1-student4').value = review1Data['1.4.s1'] || 0;
    
            // Load Review II totals
            document.getElementById('review2-student1').value = review2Data['2.1.s1'] || 0;
                document.getElementById('review2-student2').value = review2Data['2.2.s1'] || 0;
                document.getElementById('review2-student3').value = review2Data['2.3.s1'] || 0;
                document.getElementById('review2-student4').value = review2Data['2.4.s1'] || 0;
    
            // Load Review III totals
             document.getElementById('review3-student1').value = review3Data['f81'] || 0;
                document.getElementById('review3-student2').value = review3Data['f82'] || 0;
                document.getElementById('review3-student3').value = review3Data['f83'] || 0;
                document.getElementById('review3-student4').value = review3Data['f84'] || 0;

    
            // Load Review IV totals
            document.getElementById('review4-student1').value = review4Data['f4.1.s1'] || 0;
                document.getElementById('review4-student2').value = review4Data['f4.2.s1'] || 0;
                document.getElementById('review4-student3').value = review4Data['f4.3.s1'] || 0;
                document.getElementById('review4-student4').value = review4Data['f4.4.s1'] || 0;
        }
    
        // Calculate final totals for each student
        function calculateFinalTotals() {
            for (let i = 1; i <= 4; i++) {
                let total = 0;
                
                // Sum all review totals for this student
                for (let j = 1; j <= 4; j++) {
                    const reviewValue = parseFloat(document.getElementById(`review${j}-student${i}`).value) || 0;
                    total += reviewValue;
                }
                
                // Set the final total (out of 100)
                document.getElementById(`final-student${i}`).value = total;
            }
        }
    
        // Navigation to previous review
        function previousReview() {
            // Save current form data before navigating back
            saveFormData();
            window.location.href = '/review4';
        }
    
        // Save form data to session storage
        function saveFormData() {
            const formData = {
                group_id: document.getElementById('group_id').value,
                final_comments: document.getElementById('comments').value
            };
            
            // Add all review totals to the saved data
            for (let i = 1; i <= 4; i++) {
                for (let j = 1; j <= 4; j++) {
                    formData[`review${i}_${j}`] = document.getElementById(`review${i}-student${j}`).value;
                }
            }
            
            sessionStorage.setItem('review5_data', JSON.stringify(formData));
        }
    
        // Submit form to generate PDF
        async function submitForm() {
            try {
                const submitBtn = document.getElementById('generate-pdf');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Generating PDF...';
    
                // Save data before submitting
                saveFormData();
    
                const formData = new FormData(document.getElementById('form-data'));
                const response = await fetch('/generate-pdf-review5', {
                    method: 'POST',
                    body: JSON.stringify(Object.fromEntries(formData)),
                    headers: { 'Content-Type': 'application/json' }
                });
    
                if (!response.ok) {
                    throw new Error(await response.text());
                }
    
                // Handle PDF download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Final_Review_Summary.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
    
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert(`Failed to generate PDF: ${error.message}`);
            } finally {
                const submitBtn = document.getElementById('generate-pdf');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Generate Final PDF';
                }
            }
        }
        // Header hide/show on scroll functionality
let lastScrollTop = 0;
let scrollThreshold = 5;
let isHeaderVisible = true;

function handleScroll() {
    const header = document.querySelector('.page-header');
    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (Math.abs(currentScrollTop - lastScrollTop) < scrollThreshold) {
        return;
    }

    // Hide header when scrolling down
    if (currentScrollTop > lastScrollTop && currentScrollTop > 100 && isHeaderVisible) {
        header.classList.add('hidden');
        isHeaderVisible = false;
    }
    // Show header when scrolling up
    else if (currentScrollTop < lastScrollTop && !isHeaderVisible) {
        header.classList.remove('hidden');
        isHeaderVisible = true;
    }

    // Optional: Add scrolled class for visual feedback
    if (currentScrollTop > 80) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }

    lastScrollTop = currentScrollTop;
}

// Throttling for better performance
let scrollTimer = null;
function throttledScroll() {
    if (scrollTimer) return;
    scrollTimer = setTimeout(() => {
        handleScroll();
        scrollTimer = null;
    }, 10);
}

document.addEventListener('DOMContentLoaded', function() {
    // Your existing DOMContentLoaded code...
    window.addEventListener('scroll', throttledScroll, { passive: true });
});

    </script>
     <script>
        let menuOpen = false;

        function toggleMenu() {
            const menuToggle = document.querySelector('.menu-toggle');
            const menuDropdown = document.getElementById('menuDropdown');
            
            menuOpen = !menuOpen;
            
            if (menuOpen) {
                menuToggle.classList.add('active');
                menuDropdown.classList.add('show');
            } else {
                menuToggle.classList.remove('active');
                menuDropdown.classList.remove('show');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menuContainer = document.querySelector('.menu-container');
            
            if (!menuContainer.contains(event.target) && menuOpen) {
                toggleMenu();
            }
        });

        // Close menu when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && menuOpen) {
                toggleMenu();
            }
        });

        // Highlight current page
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('current');
                }
            });
        });
    </script>
</body>
</html>